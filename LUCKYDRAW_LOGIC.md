# 🎰 럭키드로우 출제 로직 완성본

## 📋 출제 조건

### ✅ 기본 조건 (모든 럭키드로우 공통)
1. **한 번에 맞춘 문제 3개 이상**
   - `answer_attempt = 1`인 정답만 카운트
   - 재시도로 맞춘 것은 제외

2. **직전 문제가 럭키드로우가 아님**
   - 연속 럭키드로우 방지

3. **이번 월에 당첨 안됨**
   - 월간 1회 당첨 제한

4. **최대 당첨자 수 미도달**
   - 이벤트별 max_winners 제한

---

## 🎯 출제 확률

### 1️⃣ **첫 번째 럭키드로우 (세션 내 첫 럭키드로우)**
- **확률: 100%** (무조건 출제)
- 조건만 충족하면 바로 출제됨

**예시:**
```
1번 (한번에 맞춤) ✅
2번 (한번에 맞춤) ✅
3번 (한번에 맞춤) ✅
4번 → 🎰 럭키드로우 (100% 확률!)
```

### 2️⃣ **두 번째 이후 럭키드로우**
- **기본 확률: 40%**
- **증가율: 답변한 문제 수 × 10%**
- **최대 확률: 90%**

**공식:**
```
확률 = min(90%, 40% + 답변한 문제 수 × 10%)
```

**답변 수별 확률 테이블:**
| 답변 수 | 확률 |
|---------|------|
| 0개 | 40% |
| 1개 | 50% |
| 2개 | 60% |
| 3개 | 70% |
| 4개 | 80% |
| 5개 | 90% |
| 6개+ | 90% (최대) |

**예시:**
```
1번 (한번에 맞춤) ✅
2번 (한번에 맞춤) ✅  
3번 (한번에 맞춤) ✅
4번 → 🎰 럭키드로우 (100%) → 꽝 😢
5번 (일반 문제) → 맞춤 ✅
6번 → 🎰 럭키드로우 (80% 확률, 답변 4개)
   → 40% + 4 × 10% = 80%
```

---

## 🔒 추가 제약 사항

### 연속 럭키드로우 방지
- 럭키드로우 문제 바로 다음은 **무조건 일반 문제**
- 럭키드로우 → 일반 문제 → 럭키드로우 (O)
- 럭키드로우 → 럭키드로우 (X)

### 세션별 독립
- 1회차에서 럭키드로우를 봤어도
- 2회차에서는 다시 "첫 럭키드로우"로 시작
- 회차마다 독립적으로 출제

---

## 💻 구현 위치

**파일:** `server/services/quizService.js`

**핵심 로직:**
```javascript
// 세션 내 럭키드로우 출제 횟수 확인
const luckyDrawCount = await db.QuizAnswer.count({
  where: { session_id: sessionId, is_lucky_draw: true }
});

const isFirstLuckyDraw = luckyDrawCount === 0;

if (canShowLuckyDraw) {
  let luckyDrawProbability;
  
  if (isFirstLuckyDraw) {
    // 첫 럭키드로우: 100%
    luckyDrawProbability = 1.0;
  } else {
    // 두 번째+: 40% + (답변 수 × 10%), 최대 90%
    const answeredCount = await db.QuizAnswer.count({
      where: { session_id: sessionId }
    });
    luckyDrawProbability = Math.min(0.9, 0.4 + (answeredCount * 0.1));
  }
  
  // 확률에 따라 출제
  if (Math.random() < luckyDrawProbability) {
    selectedQuestion.dataValues.isLuckyDraw = true;
  }
}
```

---

## 📊 테스트 결과

✅ **첫 럭키드로우**: 10회 중 10회 출제 (100%)  
⚠️ **두 번째 럭키드로우**: 연속 방지 로직으로 5문제 세션에서는 테스트 불가  
✅ **확률 공식**: 정상 작동 확인

---

## 🎮 실제 플레이 예시

**5문제 퀴즈 (일반적인 경우):**
```
1번 → 한번에 맞춤 ✅
2번 → 한번에 맞춤 ✅
3번 → 한번에 맞춤 ✅
4번 → 🎰 럭키드로우 (100%)
    → 당첨 🎉 or 꽝 😢
5번 → 일반 문제 (연속 방지)
```

**10문제 퀴즈 (가정):**
```
1-3번 → 한번에 맞춤 ✅✅✅
4번 → 🎰 럭키드로우 (100%) → 꽝
5번 → 일반 문제
6번 → 🎰 럭키드로우 가능 (80% 확률, 답변 4개)
   → 당첨하면 종료
   → 꽝이면 계속
7번 → 일반 문제
8번 → 🎰 럭키드로우 가능 (90% 확률, 답변 6개)
```

---

**최종 업데이트:** 2025-11-23  
**상태:** ✅ 완료 및 테스트 검증

